<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Decode TopoJSON</title>
  </head>
  <body>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <script>
      // TopoJSON 数据
      const topology = {
        type: "Topology",
        arcs: [
          [
            [0, 50560],
            [0, 15218],
            [10200, 0],
            [0, -15218],
            [-10200, 0],
          ],
        ],
        transform: {
          scale: [0.00882333570523043, 0.008542813820499722],
          translate: [20.00000000000003, 3.0760617112916044],
        },
        objects: {
          regions: {
            type: "GeometryCollection",
            geometries: [
              {
                arcs: [[0]],
                type: "Polygon",
                properties: {
                  BORDERLEVEL: "COUNTY",
                  NAME: "澎湖縣",
                  ID: "X",
                  CODE: "10016",
                  ENG: "Penghu County",
                },
              },
            ],
          },
        },
      };

      // 解码 arcs 为绝对坐标
      function decodeArcs(arcs, transform) {
        const { scale, translate } = transform;
        const absoluteCoords = [];

        arcs.forEach((arcIndex) => {
          const arc = topology.arcs[arcIndex]; // 获取 arc

          if (!arc) {
            console.error(`未找到 arc 索引: ${arcIndex}`);
            return;
          }

          let x = 0,
            y = 0; // 初始化绝对坐标起点

          arc.forEach(([dx, dy]) => {
            x += dx; // 计算相对坐标
            y += dy;
            // 转换为绝对坐标
            absoluteCoords.push([
              x * scale[0] + translate[0],
              y * scale[1] + translate[1],
            ]);
          });
        });

        return absoluteCoords;
      }

      // 将坐标转换为 SVG 路径数据
      function coordsToPath(coords) {
        if (!coords || coords.length === 0) {
          console.error("坐标数据为空，无法生成路径");
          return "";
        }
        let d = `M${coords[0][0]},${coords[0][1]}`;
        for (let i = 1; i < coords.length; i++) {
          d += `L${coords[i][0]},${coords[i][1]}`;
        }
        d += "Z"; // 闭合路径
        return d;
      }

      // 测试
      try {
        const regionArcs = topology.objects.regions.geometries[0].arcs[0];
        console.log("处理的 regionArcs 数据:", regionArcs);

        const decodedCoords = decodeArcs(regionArcs, topology.transform);
        console.log("澎湖縣的绝对坐标：", decodedCoords);

        const svgPath = coordsToPath(decodedCoords);
        console.log("澎湖縣的 SVG 路径 (d)：", svgPath);

        // 在页面中渲染路径（可视化验证）
        const svg = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "svg"
        );
        svg.setAttribute("viewBox", "0 0 1000 1000");
        svg.setAttribute("xmlns", "http://www.w3.org/2000/svg");
        svg.style.border = "1px solid black";
        document.body.appendChild(svg);

        const path = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "path"
        );
        path.setAttribute("d", svgPath);
        path.setAttribute("stroke", "black");
        path.setAttribute("fill", "none");
        svg.appendChild(path);
      } catch (error) {
        console.error("处理 arcs 时出错:", error);
      }
    </script>
  </body>
</html>
